var slice=[].slice;!function(a){var b;return a.fn.sketch=function(){var c,d,e;return d=arguments[0],c=2<=arguments.length?slice.call(arguments,1):[],this.length>1&&a.error("Sketch.js can only be called on one element at a time."),e=this.data("sketch"),"string"==typeof d&&e?e[d]?"function"==typeof e[d]?e[d].apply(e,c):0===c.length?e[d]:1===c.length?e[d]=c[0]:void 0:a.error("Sketch.js did not recognize the given command."):e?e:(this.data("sketch",new b(this.get(0),d)),this)},a.fn.clear=function(){var a;a=this.data("sketch"),void 0!==a&&(a.context.clearRect(0,0,a.canvas[0].width,a.canvas[0].height),a.context=a.el.getContext("2d"),a.actions=[],a.action=null,a.images=[])},a.fn.loadImage=function(a){var b,c;if(c=this.data("sketch"),void 0!==c)return b=new Image,b.onload=function(){return c.images.push(b),c.context.drawImage(b,0,0)},b.src=a},b=function(){function b(b,c){this.el=b,this.canvas=a(b),this.context=b.getContext("2d"),this.options=a.extend({toolLinks:!0,defaultTool:"marker",defaultColor:"#000000",defaultSize:5},c),this.painting=!1,this.color=this.options.defaultColor,this.size=this.options.defaultSize,this.tool=this.options.defaultTool,this.actions=[],this.action=null,this.images=[],this.canvas.bind("click mousedown mouseup mousemove mouseleave mouseout touchstart touchmove touchend touchcancel",this.onEvent),this.canvas.bind("load",this.onLoad),this.canvas.bind("clear",this.onClear),this.options.toolLinks&&a("body").delegate('[data-sketch-id="'+this.canvas.attr("id")+'"]',"click",function(b){var c,d,e,f,g,h,i;for(d=a(this),c=a("#"+d.data("sketch-id")),i=c.data("sketch"),h=["color","size","tool"],e=0,g=h.length;e<g;e++)f=h[e],d.attr("data-"+f)&&i.set(f,a(this).attr("data-"+f));return a(this).attr("data-download")&&i.download(a(this).attr("data-download")),!1})}return b.prototype.download=function(a){var b;return a||(a="png"),"jpg"===a&&(a="jpeg"),b="image/"+a,window.open(this.el.toDataURL(b))},b.prototype.set=function(a,b){return this[a]=b,this.canvas.trigger("sketch.change"+a,b)},b.prototype.startPainting=function(){return this.painting=!0,this.action={tool:this.tool,color:this.color,size:parseFloat(this.size),events:[]}},b.prototype.stopPainting=function(){return this.action&&this.actions.push(this.action),this.painting=!1,this.action=null,this.redraw()},b.prototype.onEvent=function(b){return b.originalEvent&&b.originalEvent.targetTouches&&("touchend"===b.type?(b.pageX=b.originalEvent.pageX,b.pageY=b.originalEvent.pageY):(b.pageX=b.originalEvent.targetTouches[0].pageX,b.pageY=b.originalEvent.targetTouches[0].pageY)),a.sketch.tools[a(this).data("sketch").tool].onEvent.call(a(this).data("sketch"),b),b.preventDefault(),!1},b.prototype.onLoad=function(b,c){var d;return d=a(this).data("sketch"),d.actions=d.actions.concat(c),d.redraw(),b.preventDefault(),!1},b.prototype.onClear=function(b){var c;return c=a(this).data("sketch"),c.actions=[],c.redraw(),b.preventDefault(),!1},b.prototype.redraw=function(){var b;return this.el.width=this.canvas.width(),this.context=this.el.getContext("2d"),b=this,a.each(this.actions,function(){if(this.tool)return a.sketch.tools[this.tool].draw.call(b,this)}),this.painting&&this.action&&a.sketch.tools[this.action.tool].draw.call(b,this.action),a.each(this.images,function(){if(this)return b.context.drawImage(this,0,0)})},b}(),a.sketch={tools:{}},a.sketch.tools.marker={onEvent:function(a){var b;switch(a.type){case"mousedown":case"touchstart":this.painting&&this.stopPainting(),this.startPainting(),this.canvas.trigger("stroke-start",this.action);break;case"mouseup":case"mouseout":case"mouseleave":case"touchend":case"touchcancel":this.action&&this.canvas.trigger("stroke-end",this.action),this.stopPainting()}if(this.painting)return b={x:a.pageX-this.canvas.offset().left,y:a.pageY-this.canvas.offset().top,event:a.type},this.action.events.push(b),this.canvas.trigger("stroke-extend",b),this.redraw()},draw:function(a){var b,c,d,e,f;for(this.context.lineJoin="round",this.context.lineCap="round",this.context.beginPath(),this.context.moveTo(a.events[0].x,a.events[0].y),f=a.events,c=0,d=f.length;c<d;c++)b=f[c],this.context.lineTo(b.x,b.y),e=b;return this.context.strokeStyle=a.color,this.context.lineWidth=a.size,this.context.stroke()}},a.sketch.tools.eraser={onEvent:function(b){return a.sketch.tools.marker.onEvent.call(this,b)},draw:function(b){var c,d;return this.erasing=!0,c=b.color,d=this.context.globalCompositeOperation,this.context.globalCompositeOperation="destination-out",b.color="rgba(0,0,0,1)",a.sketch.tools.marker.draw.call(this,b),this.context.globalCompositeOperation=d,this.erasing=!1,b.color=c}}}(jQuery);