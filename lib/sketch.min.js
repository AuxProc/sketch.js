var Sketch,slice=[].slice;(Sketch=function(){function a(a,b){this.el=a,this.canvas=$(a),this.context=a.getContext("2d"),this.options=$.extend({toolLinks:!0,defaultTool:"marker",defaultColor:"#000000",defaultSize:5},b),this.painting=!1,this.color=this.options.defaultColor,this.size=this.options.defaultSize,this.tool=this.options.defaultTool,this.actions=[],this.action=null,this.canvas.bind("click mousedown mouseup mousemove mouseleave mouseout touchstart touchmove touchend touchcancel",this.onEvent),this.canvas.bind("load",this.onLoad),this.canvas.bind("clear",this.onClear),this.options.toolLinks&&$("body").delegate('a[href="#'+this.canvas.attr("id")+'"]',"click",function(a){var b,c,d,e,f,g,h;for(c=$(this),b=$(c.attr("href")),h=b.data("sketch"),g=["color","size","tool"],d=0,f=g.length;d<f;d++)e=g[d],c.attr("data-"+e)&&h.set(e,$(this).attr("data-"+e));return $(this).attr("data-download")&&h.download($(this).attr("data-download")),!1})}return a.prototype.download=function(a){var b;return a||(a="png"),"jpg"===a&&(a="jpeg"),b="image/"+a,window.open(this.el.toDataURL(b))},a.prototype.set=function(a,b){return this[a]=b,this.canvas.trigger("sketch.change"+a,b)},a.prototype.startPainting=function(){return this.painting=!0,this.action={tool:this.tool,color:this.color,size:parseFloat(this.size),events:[]}},a.prototype.stopPainting=function(){return this.action&&this.actions.push(this.action),this.painting=!1,this.action=null,this.redraw()},a.prototype.onEvent=function(a){return a.originalEvent&&a.originalEvent.targetTouches&&("touchend"===a.type?(a.pageX=a.originalEvent.pageX,a.pageY=a.originalEvent.pageY):(a.pageX=a.originalEvent.targetTouches[0].pageX,a.pageY=a.originalEvent.targetTouches[0].pageY)),$.sketch.tools[$(this).data("sketch").tool].onEvent.call($(this).data("sketch"),a),a.preventDefault(),!1},a.prototype.onLoad=function(a,b){var c;return c=$(this).data("sketch"),c.actions=c.actions.concat(b),c.redraw(),a.preventDefault(),!1},a.prototype.onClear=function(a){var b;return b=$(this).data("sketch"),b.actions=[],b.redraw(),a.preventDefault(),!1},a.prototype.redraw=function(){var a;if(this.el.width=this.canvas.width(),this.context=this.el.getContext("2d"),a=this,$.each(this.actions,function(){if(this.tool)return $.sketch.tools[this.tool].draw.call(a,this)}),this.painting&&this.action)return $.sketch.tools[this.action.tool].draw.call(a,this.action)},a}(),$.sketch={tools:{}},$.sketch.tools.marker={onEvent:function(a){var b;switch(a.type){case"mousedown":case"touchstart":this.painting&&this.stopPainting(),this.startPainting(),this.canvas.trigger("stroke-start",this.action);break;case"mouseup":case"mouseout":case"mouseleave":case"touchend":case"touchcancel":this.action&&this.canvas.trigger("stroke-end",this.action),this.stopPainting()}if(this.painting)return b={x:a.pageX-this.canvas.offset().left,y:a.pageY-this.canvas.offset().top,event:a.type},this.action.events.push(b),this.canvas.trigger("stroke-extend",b),this.redraw()},draw:function(a){var b,c,d,e,f;for(this.context.lineJoin="round",this.context.lineCap="round",this.context.beginPath(),this.context.moveTo(a.events[0].x,a.events[0].y),f=a.events,c=0,d=f.length;c<d;c++)b=f[c],this.context.lineTo(b.x,b.y),e=b;return this.context.strokeStyle=a.color,this.context.lineWidth=a.size,this.context.stroke()}},$.sketch.tools.eraser={onEvent:function(a){return $.sketch.tools.marker.onEvent.call(this,a)},draw:function(a){var b,c;return this.erasing=!0,b=a.color,c=this.context.globalCompositeOperation,this.context.globalCompositeOperation="destination-out",a.color="rgba(0,0,0,1)",$.sketch.tools.marker.draw.call(this,a),this.context.globalCompositeOperation=c,this.erasing=!1,a.color=b}})(jQuery);